import os
import hashlib
import array, math
#location_dir = os.path.dirname(os.path.abspath(__file__))
location_dir = "/mnt/home/james/checkouts/adam_b_project/host_im/mount/malware-classification-master/"

good=location_dir+"samples/virus/"
bad=location_dir+"samples/not/"

headers=["Name", "md5", "entropy", "imports", "good", "bad", "legitimate"]


def get_entropy(data):
    if len(data) == 0:
	    return(0.0)
    occurences = array.array('L', [0]*256)
    for x in data:
  	    occurences[x if isinstance(x, int) else ord(x)] += 1

    entropy = 0
    for x in occurences:
        if x:
            p_x = float(x) / len(data)
            entropy -= p_x*math.log(p_x, 2)

            return entropy





#good = 1
#bad = 0
goodbad=[bad,good]
cases=[]
for goodbad_i in [0,1]:
    for subdir, dirs, files in os.walk(goodbad[goodbad_i]):
        for file in files:
            if file[-1]=="~": continue #Ignore emacs backups
            o={}
            f=open(goodbad[goodbad_i]+file,"r")
            data=f.read().encode("ascii")
            f.close()
            print(data)
            m=hashlib.md5()
            m.update(data)
            digest=m.hexdigest()
            o["Name"]=file
            o["md5"]=digest
            o["legitimate"]=goodbad_i
            o["entropy"]=get_entropy(data)
            o["imports"]=data.count(b"import")
            o["good"]=data.count(b"good")
            o["bad"]=data.count(b"bad")
            print(o)
            cases.append(o)


            
f=open(location_dir+"data_ab.csv", "w")


f.write("|".join(headers)+"\n")
for case in cases:
    f.write("|".join([str(case[i]) for i in headers])+"\n")
f.close()

